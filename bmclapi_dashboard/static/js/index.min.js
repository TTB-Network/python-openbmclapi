class I18NManager {
    constructor() {
        this.lang = "zh_cn"
        this.locales = {
        }
    }
    setLang(lang) {
        if (this.lang != lang) {
            this.lang = lang
            window.dispatchEvent(new CustomEvent("lang", { detail: { lang: lang } }))
        }
    }
    addLang(lang, key, value) {
        if (!(lang in this.locales)) this.locales[lang] = {}
        this.locales[lang][key] = value
        return this
    }
    addLangs(lang, tables) {
        for (const key in tables) {
            this.addLang(lang, key, tables[key])
        }
        return this
    }
    t(key, params) {
        if (!(lang in this.locales) || !(key in this.locales[lang])) return key
        t = this.locales[lang][key]
        for (const k in params) {
            t = t.replaceAll(`%${k}%`, params[k])
        }
        return t
    }
}
class Style {  
    constructor() {  
        this.themes = {  
            light: {  
                "color": "#000000",  
                "dark-color": "#FFFFFF",
                "background": "#F5F6F8",
                "selection-background": "#fff",
                "main-color": "#0FC6C2",
                "main-shadow": "rgba(15, 198, 194, 0.2)",
                "hover-color": "#0A8A87",
                "shadow": "rgba(145, 158, 171, 0.2)",
                "title-color": "rgba(0, 0, 0, 0.5)",
                "value-color": "rgba(0, 0, 0, 0.7)",
                "button-color": "rgba(0, 0, 0, 0.7)",
                "echarts-main-color": "#0FC6C2",
                "echarts-dark-color": "#4260f0"
            },  
            dark: {  
                "color": "#FFFFFF",  
                "dark-color": "#000000",
                "background": "#181818",
                "main-color": "#F4D1B4",
                "main-shadow": "rgba(235, 187, 151, 0.2)",
                "hover-color": "#F6A37E",
                "selection-background": "#232323",
                "shadow": "none",
                "title-color": "rgba(255, 255, 255, 0.5);",
                "value-color": "rgb(255, 255, 255);",
                "button-color": "rgba(255, 255, 255, 0.7)"
            }  
        };  
        this.documentStyle = document.createElement("style");  
        document.head.append(this.documentStyle);  
        this.$cur_theme = null
        this.applyTheme("light"); 
        this.setStyles({
            "html,body,p,h1,h2,h3,h4,h5,h6": "margin:0;padding:0",
            "*": "color: var(--color)",
            "a": "text-decoration: none",
            ".app-flex": [
                "display: flex",
                "flex-wrap: wrap"
            ],
            ".flex-space-between": "justify-content: space-between;",
            ".app-swtich-container": [
                `overflow: hidden;
                display: flex;
                padding: 5px;
                border: 1px solid transparent;
                min-height: 36px;
                height: 36px;
                border-radius: 4px;
                width: auto;
                flex-shrink: 0;`
            ],
            ".app-switch-button": [
                `display: inline-flex;
                -webkit-box-align: center;
                align-items: center;
                -webkit-box-pack: center;
                justify-content: center;
                box-sizing: border-box;
                -webkit-tap-highlight-color: transparent;
                background-color: transparent;
                outline: 0px;
                border: 0px;
                margin: 0px;
                border-radius: 5px;
                cursor: pointer;
                user-select: none;
                vertical-align: middle;
                appearance: none;
                text-decoration: none;
                font-family: inherit;
                font-weight: 500;
                line-height: 1.25;
                text-transform: uppercase;
                max-width: 360px;
                position: relative;
                flex-shrink: 0;
                overflow: hidden;
                white-space: normal;
                text-align: center;
                flex-direction: column;
                color: var(--button-color);
                padding: 4px 12px;
                min-height: 0px;
                min-width: 0px;
                font-size: 12px;
                transition: background-color 0.3s ease, color 0.3s ease;`
            ],
            ".app-switch-button.selected": [
                `background-color: var(--main-color)`,
                "color: var(--dark-color)"
            ]
        })
    }  
  
    applyTheme(themeName = "") {  
        const theme = this.themes[themeName] || this.themes[Object.keys(this.themes)[0]];  
        const rootStyles = {};  
        for (const key in theme) {  
            rootStyles[`--${key}`] = theme[key];  
        }  
        this.$cur_theme = themeName
        this.setStyle(":root", rootStyles);
        window.dispatchEvent(new Event("themeChange"))
    }  
    getTheme() {
        return this.$cur_theme;
    }
    getThemeVar(name) {
        const theme = this.themes[this.$cur_theme] || this.themes[Object.keys(this.themes)[0]];  
        return theme[name]
    }
    setStyles(tables) {
        Object.entries(tables).forEach(([key, value]) => this.setStyle(key, value)) 
    }
    setStyle(tag, code) {  
        if (Array.isArray(code)) code = code.join(";")
        if (typeof code === 'object') code = Object.entries(code).map(([key, value]) => `${key}: ${value}`).join(';');  
        const styleRule = `${tag} { ${code} }`;  
        const styleSheet = this.documentStyle.sheet;  
        if (styleSheet) {  
            try {  
                styleSheet.insertRule(styleRule, styleSheet.cssRules.length);  
            } catch (e) {  
                this.documentStyle.appendChild(document.createTextNode(styleRule));  
            }  
        } else {  
            this.documentStyle.appendChild(document.createTextNode(styleRule));  
        }  
    }  
}
class Task {
    constructor(func, delay, interval = null, ...args) {
        this.func = func
        this.args = args
        this.delay = delay
        this.interval = interval
        this._task = setTimeout(() => this._run(), delay)
    }
    _run() {
        try {
            this.func(...this.args)
        } catch (error) {
            console.error(...error)
        }
        if (this.interval != null) {
            this._task = setTimeout(() => this._run(), this.interval)
        }
    }
    block() {
        if (this._task != null) clearTimeout(this._task)
        this._task = null
    }
}
class Element {
    constructor(tag, isElement = false) {
        this.base = isElement ? tag : document.createElement(tag)
        this._resize_handler = []
        this._setText = null
        this._childrens = []
        //resize_elements.push((...event) => this._resize(...event))
    }
    setHTML(content) {
        this.base.innerHTML = content;
        return this
    }
    setText(content) {
        this.base.innerText = content;
        return this
    }
    setValue(content) {
        this.base.value = content
        return this
    }
    title(content) {
        return this.setText(content)
    }
    html(content) {
        return this.setHTML(content)
    }
    append(...elements) {
        for (const element of elements) {
            if (element instanceof Element) {
                this._childrens.push(element)
                this.base.append(element.valueOf())
            } else {
                this._childrens.push(new Element(this.isDOM(element) ? element : (new DOMParser()).parseFromString(element, 'text/html'), true))
            }
        }
        return this
    }
    id(name) {
        this.base.id = name
        return this
    }
    class(...classes) {
        for (const clazz of classes) {
            for (const cls of clazz.split(" ")) this.base.classList.add(cls)
        }
        return this
    }
    toggle(clazz) {
        this.base.classList.toggle(clazz)
        return this;
    }
    removeClass(...classes) {
        for (const clazz of classes) {
            for (const cls of clazz.split(" ")) this.base.classList.remove(cls)
        }
        return this
    }
    style(style) {
        this.base.style = style
        return this;
    }
    _resize(...event) {
        for (const func of this._resize_handler) {
            try {
                func(...event)
            } catch (e) {
                console.log(e, func)
            }
        }
    }
    setStyle(key, value) {
        this.base.style[key] = value
        return this;
    }
    valueOf() {
        return this.base
    }
    containsClass(...classes) {
        for (const clazz of classes) {
            for (const cls of clazz.split(" ")) if (this.base.classList.contains(cls)) return true
        }
        return false
    }
    setAttribute(key, value) {
        this.base.setAttribute(key, value)
        return this
    }
    isDOM(value) { return value instanceof HTMLElement ||  
        Object.prototype.toString.call(value) === '[object HTMLUnknownElement]' ||  
        (value && typeof value === 'object' && value.nodeType === 1 && typeof value.nodeName === 'string');  
    };
    clear() {
        while (this.base.firstChild != null) this.base.removeChild(this.base.firstChild)
        return this
    }
    event(name, func) {
        if (name == "resize") {
            this._resize_handler.push(func)
            return this
        }
        this.base.addEventListener(name, func)
        return this
    }
    getChildren() {
        return this._childrens
    }
}
class Router {  
    constructor(prefix = "") {    
        this._prefix = prefix;  
        this._cur = window.location.pathname.slice(this._prefix.length)
    }    
    route(page) {  
        this._cur = page
        window.dispatchEvent(new Event("popstate"));  
        history.pushState({ page: page }, "", this._prefix + page);  
    }  
    handler() {
        app.$Menu.select(this._cur.slice(1).replaceAll("/", "."))
    }
}  
class Application {
    constructor() {
        this.$Router = new Router("/pages");
        this.$Style = new Style();
        this.$content = this.createElement("div").class("main-container")
        this.$styles = {
            "*": [
                "box-sizing: border-box;magin:0;padding:0"
            ],
            "::-webkit-scrollbar, html ::-webkit-scrollbar": "width: 5px;height: 5px;border-radius: 10px",
            "::-webkit-scrollbar-thumb, html ::-webkit-scrollbar-thumb": "box-shadow: inset 0 0 6px #0000;background-color: #666;border-radius: 10px",
            "header button": [
                "border: none",
                "background: none",
                "width:  48px",
                "height: 48px",
                "border-radius: 99px",
                "transition: 300ms",
                "font-size: 24px",
                "font-weight: bolder",
                "cursor: pointer"
            ],
            "header button:hover": [
                "background: var(--main-color)",
            ],
            "header button:hover *": [
                "color: var(--dark-color)"
            ],
            "header button:active": [
                "background: var(--hover-color)",
                "color: var(--hover-color)"
            ],
            "header": [
                "background-color: var(--background)", 
                "text-align: center",  
                "min-height: 56px",
                "width: 100%",
                "padding: 8px",
                "display: flex",
                "position: fixed",
                "flex-wrap: nowrap",
                "align-items: center", "justify-content: space-between",
                "z-index: 1",
            ],
            "body": [
                "background: var(--background)",
                "background-size: cover",
                "width: 100vw",
                "height: 100vh"
            ],
            ".main": "position: relative; top: 56px; display: flex; min-height: calc(100vh - 56px)",
            ".side": [
                "position: fixed",
                "min-width: 240px",
                "padding: 20px",
                "height: 100%",
                "box-shadow: var(--shadow) 0px 4px 10px",
                "opacity: 1",
                "transition: min-width 250ms linear 0s, width 250ms linear 0s, padding 250ms linear 0s, box-shadow 250ms linear 0s, opacity 250ms linear 0s",
                "background: var(--background)"
            ],
            ".side.hidden": [
                "min-width: 0",
                "width: 0",
                "padding: 0",
                "opacity: 0",
                "box-shadow: none",
            ],
            ".main-container": [
                "min-width: calc(100% - 240px)",
                "width: 100%",
                "padding: 20px",
                "margin-left: 240px",
                "transition: width 250ms linear 0s, padding 250ms linear 0s",
            ],
            ".side.hidden ~ .main-container": [
                "min-width: 100%",
                "width: 100%",
                "padding: 20px",
                "margin-left: 0px",
                "transition: width 250ms linear 0s, padding 250ms linear 0s",
            ],
            "header .content": [
                "display: flex",
                "align-items: center"
            ],
            "header .content h3": [
                "border-left: 1px solid var(--shadow)",
                "padding: 8px"
            ],
            "header .content i": [
                "padding: 8px",
                "cursor: pointer",
            ],
            "header i.bx.bx-user-circle": [
                "font-size: 32px",
            ],
            ".main-container .panel": [
                `background-color: var(--selection-background);
                color: rgb(0, 0, 0);
                transition: box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
                border-radius: 4px;
                background-image: none;
                padding: 24px;
                box-shadow: var(--shawdow) 0px 4px 10px;
                margin: 16px;`
            ],
            ".main-container .panel.nopadding": [
                "padding: 0;"
            ],
            ".main-container .panel .title": [
                `display: flex;
                margin: 0px 0px 6px;
                font-family: inherit;
                font-weight: 400;
                line-height: 1.5;
                color: var(--title-color);
                font-size: 14px;`
            ],
            ".main-container .panel .value": [
                `margin: 0px;
                font-family: inherit;
                font-weight: 400;
                line-height: 1.5;
                color: var(--value-color);
                font-size: 24px;`
            ]
        }
        this.$side = this.createElement("aside").class("side")
        this.$container = this.createElement("div").class("main").append(
            this.$side,
            this.$content
        )
        let theme = (new Boolean(parseInt(getCookie("theme")))).valueOf()
        console.log(theme)
        if (!theme) {
            theme = "moon"
            this.$Style.applyTheme("light")
        } else {
            theme = "sun"
            this.$Style.applyTheme("dark")
        }
        this.$theme = this.createElement("i").class("bx", `bxs-${theme}`).style("font-size: 32px").event("click", () => {
            if (this.$theme.containsClass("bxs-moon")) {
                this.$theme.removeClass("bxs-moon")
                this.$theme.class("bxs-sun")
                this.$Style.applyTheme("dark")
            } else {
                this.$theme.class("bxs-moon")
                this.$theme.removeClass("bxs-sun")
                this.$Style.applyTheme("light")
            }
            document.cookie = `theme=${this.$theme.containsClass("bxs-sun") ? "1" : "0"}; path=/`
        }),
        this.$header = this.createElement("header").append(
            this.createElement("div").class("content").append(
                this.createElement("i").class("bx bx-menu").style("font-size: 32px").event("click", () => {
                    this.$side.toggle("hidden")
                    setTimeout(() => {
                        window.dispatchEvent(new Event("resize"))
                    }, 500)
                }),
                this.$theme,
                this.createElement("h3").append(
                    this.createElement("a").setAttribute("href", $github).setText(document.title)
                )
            ),
            this.createElement("button").append(
                this.createElement("i").class("bx", "bx-user-circle")
            )
        )
        document.body.prepend(
            this.$header.valueOf(),
            this.$container.valueOf(),
        )
        this.$Style.setStyles(this.$styles)
        this.$Menu = new Menu(this, this.$side);
        this.$flexes = []
        window.addEventListener("resize", () => {
            for (const flex of this.$flexes) {
                flex.update(false)
            }
        })
    }
    runTaskLater(handler, delay, ...args) {
        return new Task(handler, delay, null, ...args)
    }
    runTaskRepeat(handler, delay, interval, ...args) {
        return new Task(handler, delay, interval, ...args)
    }
    addFlex(element) {
        this.$flexes.push(element)
    }
    resizeFlex(cur) {
        for (const flex of this.$flexes) {
            if (cur.base == flex.base) continue
            flex.update(false)
        }
    }
    createFlex(noUpdateOther = false) {
        return new ElementFlex("div", false, noUpdateOther)
    }
    createEcharts() {
        return new TemplateEchart()
    }
    createElement(tag) {
        return new Element(tag);
    }
    setStyles(tables) {
        this.$Style.setStyles(tables)
    }
    getThemeVar(name) {
        return this.$Style.getThemeVar(name)
    }
}
class Preloader {
    constructor() {
        this.$page = app.createElement("div").class("preloader")
        this.$page.append(
            app.createElement("div").class("load")
        )
        this.$styles = {
            ".preloader": `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1003;
            background: #000000;
            overflow: hidden;
            opacity: 1;
            transition: opacity 500ms linear 0s`,
            ".preloader.hidden": "opacity: 0",
            ".preloader .load": `display: block;
            position: relative;
            left: 50%;
            top: 50%;
            width: 150px;
            height: 150px;
            margin: -75px 0 0 -75px;
            border-radius: 50%;
            box-shadow: 0 8px 8px 0 #0FC6C2;
            transform: translate3d(0,0,0);
            animation: spin 2s linear infinite;`,
        }
        app.$Style.setStyles(this.$styles)
        document.body.prepend(this.$page.valueOf());
        (new Array(...document.body.children)).forEach(e => {
            if (e == this.$page.valueOf()) return
            e.style.display = "none"
        })
        window.addEventListener("load", () => {
            this.$page.class("hidden");
            setTimeout(() => {
                document.body.removeChild(this.$page.valueOf());
            }, 500);
            (new Array(...document.body.children)).forEach(e => {
                if (e == this.$page.valueOf()) return
                e.style.display = ""
            })
        })
    }
}
class Menu {  
    constructor(app, side) {  
        this.$app = app
        this.$Router = app.$Router
        this.$menus = {}
        this.$base = app.createElement("div").class("list")
        this.$styles = {
            ".side .menu": [
                `outline: 0px;
                border: 0px;
                margin: 0px 0px 4px;
                cursor: pointer;
                user-select: none;
                vertical-align: middle;
                appearance: none;
                color: inherit;
                display: flex;
                -webkit-box-flex: 1;
                -webkit-box-pack: start;
                justify-content: flex-start;
                -webkit-box-align: center;
                align-items: center;
                position: relative;
                text-decoration: none;
                min-width: 0px;
                box-sizing: border-box;
                text-align: left;
                padding: 8px 16px;
                transition: background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
                height: 46px;
                border-radius: 4px;`
            ],
            ".side .menu:hover": [
                "background-color: transparent;",
                "color: var(--main-color)"
            ],
            ".side .menu.selected": [
                "background: var(--main-color)",
                "box-shadow: var(--main-shadow) 0px 10px 25px 0px",
            ],
            ".side .menu.selected span": [
                "color: var(--dark-color)",
            ],
            ".side .menu.selected i": [
                "transform: rotate(90deg)",
                "color: var(--dark-color)",
            ],
            ".side .submenu": [
                `-webkit-tap-highlight-color: transparent;
                background-color: transparent;
                outline: 0px;
                border: 0px;
                margin: 0px 0px 4px;
                cursor: pointer;
                user-select: none;
                vertical-align: middle;
                appearance: none;
                color: inherit;
                display: flex;
                -webkit-box-flex: 1;
                flex-grow: 1;
                -webkit-box-pack: start;
                justify-content: flex-start;
                -webkit-box-align: center;
                align-items: center;
                position: relative;
                text-decoration: none;
                min-width: 0px;
                box-sizing: border-box;
                text-align: left;
                padding: 8px 16px;
                transition: background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
                height: 40px;
                border-radius: 4px;`
            ],
            ".side .submenus": [
                "display: none"
            ],
            ".side .submenus.show": [
                "display: block"
            ],
            ".side .submenu .cycle span": [
                `width: 4px;
                height: 4px;
                background-color: rgba(0, 0, 0, 0.7);
                border-radius: 50%;`
            ],
            ".side .submenu.selected .cycle span": [
                "background: var(--main-color)",
                "width: 8px",
                "height: 8px"
            ],
            ".side .submenu.selected .text": [
                "font-weight: 700;"
            ],
            ".side .submenu .cycle": [
                `margin-left: 4px;
                width: 10px;
                display: flex;
                -webkit-box-pack: center;
                justify-content: center`
            ],
            ".side .submenu .text": [
                `flex: 1 1 auto;
                min-width: 0px;
                margin-top: 4px;
                margin-bottom: 4px;
                margin-left: 16px;
                color: rgba(0, 0, 0, 0.7);`
            ],
            ".side .list": [
                "overflow: auto"
            ]
        }
        side.append(this.$base)
        this.$index = {}
        this.$last_key =
        this.$app.setStyles(this.$styles)
    }  
    add(key, core) {
        let sub;
        [key, sub] = this.get_key(key)
        if (!(key in this.$menus)) this.$menus[key] = { core, children: [] }
        if (sub != null) this.$menus[key].children.push({key: sub, core})
        else this.$menus[key].core = core
    }
    setIcon(key, icon) {
        let sub;
        [key, sub] = this.get_key(key)
        if (sub != null && key in this.$menus) {
            this.$menus[key].children = this.$menus[key].children.forEach(v => () => {
                if (v.key == sub) v.icon = icon
            })
        }
        if (sub == null && key in this.$menus) this.$menus[key].icon = icon
    }
    remove(key) {
        let sub;
        [key, sub] = this.get_key(key)
        if (sub != null && key in this.$menus) {
            this.$menus[key].children = this.$menus[key].children.filter(v => v.key != sub)
        }
        if (sub == null && key in this.$menus) delete this.$menus[key]
    }
    render() {
        this.$base.clear()
        for (const key in this.$menus) {
            const object = this.$menus[key]
            const div = app.createElement("div").class("menu")
            div.append(app.createElement("div").setHTML(object.icon || ""), app.createElement("span").setText(key)).event("click", () => {
                let page = key
                if (object.children.length != 0) {
                    page += "/" + object.children[0].key
                }
                this.$Router.route("/" + page)
                this.$Router.handler()
            })
            this.$index[key] = {div}
            if (object.children.length != 0) {
                div.append(app.createElement("i").class("bx bx-chevron-right"))
            }
            this.$base.append(div)
            if (object.children.length != 0) {
                const sub = app.createElement("div").class("submenus")
                const subIndex = {}
                for (const subObject of object.children) {
                    const subdiv = app.createElement("div").class("submenu")
                    subdiv.append(app.createElement("div").class("cycle").append(app.createElement("span")), app.createElement("div").class("text").append(app.createElement("span").setText(subObject.key))).event("click", () => {
                        let page = key + "/" + subObject.key
                        this.$Router.route("/" + page)
                        this.$Router.handler()
                    })
                    sub.append(subdiv)
                    subIndex[subObject.key] = subdiv
                }
                this.$index[key].sub = {main: sub, index: subIndex}
                this.$base.append(sub)
            }
        } 
    }
    getFirst() {
        const key = Object.keys(this.$menus)[0]
        let rkey = key
        if (this.$menus[key].children.length != 0) {
            rkey += "/" + this.$menus[key].children[0].key
        }
        return rkey
    }
    select(raw_key) {
        if (!raw_key) raw_key = this.getFirst()
        let sub, key;
        [key, sub] = this.get_key(raw_key)
        for (const div in this.$index) {
            this.$index[div].div.removeClass("selected")
            if (this.$index[div].sub != null) {
                this.$index[div].sub.main.removeClass("show")
                for (const sub in this.$index[div].sub.index) {
                    this.$index[div].sub.index[sub].removeClass("selected")
                }
            }
        }
        if (!(key in this.$index)) return
        this.$index[key].div.class("selected")
        if (sub != null) {
            this.$index[key].sub.main.class("show")
            this.$index[key].sub.index[sub].class("selected")
        }
        this.page(raw_key)
    }
    get_key(key) {
        let sub = null;
        [key, sub] = key.split(".", 2)
        return [key, sub]
    }
    page(raw_key) {
        let sub, key;
        while (document.getElementsByClassName("main-container")[0].firstChild != null) document.getElementsByClassName("main-container")[0].removeChild(document.getElementsByClassName("main-container")[0].firstChild)
        if (this.$last_key != null) {
            [key, sub] = this.get_key(this.$last_key)
            if (sub != null) {
                this.$menus[key].children.forEach(e => {
                    if (e.key == sub) {
                        if (e.core != null && ("disconnect" in e.core)) {
                            try {
                                e.core.disconnect()
                            } catch (e) {
                                console.log(e)
                            }
                        } 
                    }
                })
            } else {
                if (this.$menus[key].core != null && ("disconnect" in this.$menus[key].core)) {
                    try {
                        this.$menus[key].core.disconnect()
                    } catch (e) {
                        console.log(e)
                    }
                }
            }
        }
        var r = null;
        $progress.set(50);
        [key, sub] = this.get_key(raw_key)
        if (sub != null) {
            this.$menus[key].children.forEach(e => {
                if (e.key == sub) {
                    if (e.core != null && ("connect" in e.core)) {
                        try {
                            r = e.core.connect()
                        } catch (e) {
                            console.log(e)
                        }
                    } 
                }
            })
        } else {
            if (this.$menus[key].core != null && ("connect" in this.$menus[key].core)) {
                try {
                    r = this.$menus[key].core.connect()
                } catch (e) {
                    console.log(e)
                }
            }
        }
        if (r != null) {
            if (!(r instanceof Promise)) r = new Promise((resolve, reject) => {
                resolve(r);
            })
            r.then((page) => {
                $progress.set(100);
                if (!Array.isArray(page)) page = [page]
                document.getElementsByClassName("main-container")[0].append(...page.map(e => e instanceof Element ? e.valueOf() : e))
            }).catch((page) => {
                $progress.set(100);
            })
        }
    }
    resize() {
        if (this.$last_key != null) {
            [key, sub] = this.get_key(this.$last_key)
            if (sub != null) {
                this.$menus[key].children.forEach(e => {
                    if (e.key == sub) {
                        if (e.core != null && ("resize" in e.core)) {
                            try {
                                e.core.resize()
                            } catch (e) {
                                console.log(e)
                            }
                        } 
                    }
                })
            } else {
                if (this.$menus[key].core != null && ("resize" in this.$menus[key].core)) {
                    try {
                        this.$menus[key].core.resize()
                    } catch (e) {
                        console.log(e)
                    }
                }
            }
        }
    }
}  
class ProgressBar {
    constructor() {
        this.$base = app.createElement("div").class("progressbar");
        this.$cur = 0
        this.$task = 0
        this.$value = 0
        this.$speed = 0.01;
        this.$stop = null
        app.$Style.setStyles({
            ".progressbar": [
                "height: 2px",
                "background-color: var(--main-color)",
                "position: absolute",
                "transition: width 0.5s"
            ]
        });
        document.body.prepend(this.$base.valueOf())
    }
    set(value, speed = null) {
        if (speed != null) this.$speed = speed
        this.$value = value
        this.start()
    }
    start() {  
        if (this.$task) {  
            return; 
        }  
        clearTimeout(this.$stop);
        this.$task = setInterval(() => {  
            this.increaseProgress();  
        }, (this.$speed * 1000.0));  
    }  
    increaseProgress() {  
        if (this.$cur >= this.$value) {
            this.$cur = this.$value
        }
        if (this.$value < 100 && this.$cur < this.$value) {
            this.$cur += Math.min(  
                    ((cur, value) => {
                        const threshold = value * 0.05;
                        return value - cur < threshold ? 0.5 : (value - cur) / threshold / 2
                    })(this.$cur, this.$value) * Math.sin((this.$cur / this.$value) * 0.5 + 0.5,  
                this.$value - this.$cur  
            ));
            this.updateProgress();  
        } else {  
            this.$cur = 100;
            this.updateProgress();  
            this.$stop = setTimeout(() => this.stop(), 500)
        }  
    }  
    updateProgress() {  
        this.$base.style(`width: ${this.$cur}%`)
    }  
    stop() {  
        if (this.$task) {  
            clearInterval(this.$task);  
            this.$task = null;  
            this.$base.style(`width: 0%`)
            this.$speed = 0.1;
        }  
    }  
    changeSpeed(newSpeed) {  
        this.$speed = newSpeed;
        if (this.$task) {  
            this.stop();  
            this.start();  
        }  
    }  
}
class WebSocketClient {
    constructor(url, handlers = {}) {
        this.url = url;
        this.ws = null;
        this.reconnectInterval = 1000;  // 重连间隔为1秒
        this.retryMessage = !(handlers.retryMessage || true)
        this.messageQueue = [];  // 用于缓存消息的队列
        this.handlers = handlers;  // 处理函数的对象
        this.stats = {
            sent: { count: 0, length: 0 },
            received: { count: 0, length: 0 }
        };
        this.connect()
        this.reconnectTask = null;
    }

    close() {
        this.ws.close();
    }

    connect() {
        this.ws = new WebSocket(this.url);

        // 当连接打开时，发送所有缓存的消息，并调用处理函数
        this.ws.onopen = () => {
            if (this.reconnectTask !== null) {
                clearInterval(this.reconnectTask)
                this.reconnectTask = null
            }
            while (this.messageQueue.length > 0) {
                let message = this.messageQueue.shift();
                this.send(message)
            }
            if (this.handlers.onopen) {
                this.handlers.onopen();
            }
        };

        // 当接收到消息时，调用处理函数
        this.ws.onmessage = (event) => {
            this.stats.received.count++;
            this.stats.received.length += event.data.length;
            if (this.handlers.onmessage) {
                this.handlers.onmessage(event);
            }
        };

        // 当连接关闭时，尝试重新连接，并调用处理函数
        this.ws.onclose = () => {
            this.ws = null
            if (this.handlers.onclose) {
                this.handlers.onclose();
            }
            this.reconnectTask = setTimeout(() => this.connect(), this.reconnectInterval)
        };
    }

    send(data) {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.stats.sent.count++;
            this.stats.sent.length += this.calculateBytes(data);
            this.ws.send(data instanceof BytesBuffer ? data.toBytes() : data);
        } else {
            if (!this.ws || this.ws.readyState === WebSocket.CLOSED) {
                this.connect();
            }
            if (this.retryMessage)
                this.messageQueue.push(data);
        }
    }
    calculateBytes(data) {  
        let bytes;
        if (typeof data === "string") bytes = (new TextEncoder()).encode(data).byteLength
        else if (data instanceof ArrayBuffer || data instanceof DataView || data instanceof Uint8Array) bytes = data.byteLength;
        else if (data instanceof Blob) bytes = data.size
        else if (data instanceof BytesBuffer) bytes = data.len()
        else bytes = (new TextEncoder()).encode(String(data)).byteLength
        return bytes;  
    } 
    getStats() {
        return this.stats;
    }
}
class MinecraftUtils {
    static getVarInt(data) {
        let r = [];
        while (true) {
            if ((data & 0xFFFFFF80) === 0) {
                r.push(data);
                break;
            }
            r.push(data & 0x7F | 0x80);
            data >>= 7;
        }
        return r;
    }
    static getVarIntLength(data) {
        return this.getVarInt(data).length;
    }
}
class BytesBuffer {
    constructor(...data) {
        this.buffer = []
        this.cur = 0
        this.write(...data)
    }
    write(...values) {
        for (const value of values) {
            if (value instanceof BytesBuffer) {
                this.buffer.push(...value.buffer)
            } else if (Number.isInteger(value)) {
                this.buffer.push(value < 0 ? value + 256 : value)
            } else if (Array.isArray(value) && value.filter(v => Number.isInteger(v)).length == value.length) {
                value.forEach(v => this.write(v))
            } else if (value instanceof Uint8Array) {
                for (let i = 0; i < value.byteLength; i++) {
                    this.write(value[i])
                }
            } else if (value instanceof ArrayBuffer) {
                this.write(new Uint8Array(value))
            } else if (!value === undefined) {
                console.log(typeof value, "buf", value)
            }
        }
    }
    read(length = 1) {
        let data = []
        for (let i = 0; i < length; i++) data.push(...this.buffer.slice(this.cur + i, this.cur + i + 1))
        this.cur += length
        return data;
    }
    tell() {
        return this.cur
    }
    readBytes(length) {
        return this.read(length);
    }
    sizeof() {
        return this.buffer.length;
    }
    len() {
        return this.buffer.length;
    }
    toBytes() {
        return new Uint8Array(this.buffer)
    }
    copy() {
        let buf = []
        this.buffer.forEach(v => buf.push(v))
        return buf
    }
}
class DataOutputStream extends BytesBuffer {
    constructor(data) {
        super()
        this.write(data)
    }
    writeInteger(value) {
        this.write((value >> 24) & 0xFF, (value >> 16) & 0xFF, (value >> 8) & 0xFF, (value >> 0) & 0xFF);
    }
    writeBoolean(value) {
        this.write(value ? 1 : 0)
    }
    writeFloat(value) {
        const bytes = new Uint8Array((new Float32Array([value])).buffer);  
        for (let i = 0; i < 4; i++) {  
            this.write(bytes[i]);  
        }  
    }
    writeDouble(value) {
        const bytes = new Uint8Array((new Float64Array([value])).buffer);  
        for (let i = 0; i < 8; i++) {  
            this.write(bytes[i]);  
        }  
    }
    writeVarInt(value) {
        this.write(MinecraftUtils.getVarInt(value));
        return this;
    }
    writeString(data, encoding = 'utf-8') {
        this.writeVarInt(data.length);
        this.write(new TextEncoder(encoding).encode(data));
        return this;
    }
    writeLong(data) {
        data = data - (data > Math.pow(2, 63) - 1 ? Math.pow(2, 64) : data);
        this.write((data >> 56) & 0xFF, (data >> 48) & 0xFF, (data >> 40) & 0xFF, (data >> 32) & 0xFF, (data >> 24) & 0xFF, (data >> 16) & 0xFF, (data >> 8) & 0xFF, (data >> 0) & 0xFF);
        return this;
    }
    writeUUID(uuid) {
        this.writeLong(uuid.int >> 64);
        this.writeLong(uuid.int & ((1 << 64) - 1));
        return this;
    }
}
class DataInputStream extends BytesBuffer {
    readInteger() {
        let value = this.read(4)
        return ((value[0] << 24) + (value[1] << 16) + (value[2] << 8) + (value[3] << 0))
    }
    readBoolean() {
        return Boolean(this.read(1)[0]);
    }
    readShort() {
        value = this.read(2);
        if (value[0] | value[1] < 0)
            throw EOFError()
        return ((value[0] << 8) + (value[1] << 0))
    }
    readLong() {
        let value = this.read(8)
        value = (
            (value[0] << 56) +
            ((value[1] & 255) << 48) +
            ((value[2] & 255) << 40) +
            ((value[3] & 255) << 32) +
            ((value[4] & 255) << 24) +
            ((value[5] & 255) << 16) +
            ((value[6] & 255) << 8) +
            ((value[7] & 255) << 0))
        return value < BigInt(Math.pow(2, 63) - 1) ? value : value - BigInt(Math.pow(2, 64));
    }
    readDouble() {
        return (new DataView(new Uint8Array(this.readBytes(4)))).getFloat64()
    }
    readFloat() {
        return (new DataView(new Uint8Array(this.readBytes(4)))).getFloat32()
    }
    readVarInt() {
        let i = 0;
        let j = 0;
        let k;
        while (true) {
            k = this.read(1)[0];
            i |= (k & 0x7F) << j * 7;
            j += 1;
            if ((k & 0x80) !== 128) break;
        }
        return i >= 2 ** 31 - 1 ? i - 2 ** 31 * 2 : i;
    }
    readString(maximum = null, encoding = 'utf-8') {
        return new TextDecoder(encoding).decode(new Uint8Array(this.read(maximum == null ? this.readVarInt() : maximum)));
    }
    readBytes(length) {
        return this.read(length);
    }
    readUUID() {
        let m = this.readLong();
        let l = this.readLong();
        return new UUID(m.toBytes().concat(l.toBytes()));
    }
}
class SocketData {
    constructor() {
        this.$url = window.location.protocol + "//" + window.location.host + window.location.pathname
        this.$support = true
        if (this.$support) {
            this.$cache = []
            this.$opened = false
            this.create_ws()
            this.$data = {}
        }
        this.$key = 1;
    }
    send_http(namespace, data) {
        return new Promise((resolve, reject) => {
            this.$data[key] = { resolve, reject }
            setTimeout(() => {
                if (key in this.$data) reject(new Error("Timeout."))
                delete this.$data[key]
            }, 30000)
            const xhr = new XMLHttpRequest()
            xhr.onload = (event) => {
                if (event.readyState == 4) {
                    console.log(event)
                }
            }
            xhr.setRequestHeader("Content-Type", "application/json")
            xhr.setRequestHeader("X-Accept-Encoding: binary, json")
            xhr.open("POST", `${this.$url}?namespace=${encodeURIComponent(namespace)}`)
            xhr.send(data)
        })
    }
    create_ws() {
        if (!this.$support) throw "Unable to send websocket data."
        if (this.$ws == null) this.$ws = new WebSocketClient("ws" + (this.$url.slice(4)), {
            "onmessage": (msg) => {
                this.read_blob(msg.data).then((data) => {
                    this.recv(data.readVarInt(), data.readString(), this._deserializeData(data))
                })
            },
            "onopen": () => {
                this.$opened = true
                this.$cache.forEach(e => this.$ws.send(e))
                this.$cache = []
                window.dispatchEvent(new Event("mainsocket_connect"))
            },
            "onclose": () => {
                this.$opened = false
                window.dispatchEvent(new Event("mainsocket_disconnect"))
            }
        })
    }
    read_blob(blob) {
        return new Promise((resolve, reject) => {
            let reader = new FileReader();
            reader.onload = () => {
                let arrayBuffer = reader.result;
                resolve(new DataInputStream(arrayBuffer))
            }
            reader.readAsArrayBuffer(blob)
        })
    }
    send_ws(namespace, data) {
        this.create_ws()
        return new Promise((resolve, reject) => {
            var key = this.$key++
            const buffer = new DataOutputStream()
            buffer.writeVarInt(key)
            buffer.writeString(namespace)
            buffer.write(this._serializeData(data))
            if (!this.$opened) this.$cache.push(buffer)
            else this.$ws.send(buffer)
            this.$data[key] = { resolve, reject }
            setTimeout(() => {
                if (key in this.$data) reject(new Error("Timeout."))
                delete this.$data[key]
            }, 30000)
        })
    }
    send(namespace, data, forceHttp = false) {
        if (this.$support && !forceHttp) {
            return this.send_ws(namespace, data)
        } else {
            return this.send_http(namespace, data)
        }
    }
    recv(key, namespace, data) {
        if (key in this.$data) {
            this.$data[key].resolve(data)
            delete this.$data[key]
        } 
        if (key == 0) window.dispatchEvent(new CustomEvent("mainsocket_" + namespace, { detail:data }))
        console.log(namespace, data)
    }
    _deserializeData(input) {
        const type = input.readVarInt()
        switch (type) {
            case 0: // string
                return input.readString()
            case 1: // bool
                return input.readBoolean()
            case 2: // float
                return parseFloat(input.readString())
            case 3: // bool
                return parseInt(input.readString())
            case 4: {// list
                const length = input.readVarInt()
                const data = []
                for (let _ = 0; _ < length; _++) data.push(this._deserializeData(input))
                return data
            }
            case 5: {// table
                const length = input.readVarInt()
                const data = {}
                for (let _ = 0; _ < length; _++) {
                    data[this._deserializeData(input)] = this._deserializeData(input)
                }
                return data
            }
            case 6:
                return null
            default:
                console.log(type)
                return null
        }
    }
    _serializeData(data) {
        const buf = new DataOutputStream()
        switch (typeof data) {
            case "string": {
                buf.writeVarInt(0)
                buf.writeString(data)
                break;
            }
            case "boolean": {
                buf.writeVarInt(1)
                buf.writeBoolean(data)
                break;
            }
            case "number": {
                if (Number.isInteger(data)) {
                    buf.writeVarInt(3)
                    buf.writeString(data.toString())
                }
                break;
            }
            case "object": {
                if (Array.isArray(data)) {
                    buf.writeVarInt(4)
                    buf.writeVarInt(data.length)
                    for (v of data) {
                        buf.write(this._serializeData(v))
                    }
                } else if (data != null) {
                    buf.writeVarInt(5);
                    buf.writeVarInt(Object.keys(data).length);
                    for (const key in data) {  
                        buf.write(this._serializeData(key)); 
                        buf.write(this._serializeData(data[key]));
                    }  
                } else if (data == null) {
                    buf.writeVarInt(6);
                }
                break;
            }
            case "undefined": {
                buf.writeVarInt(6); 
                break;
            }
            default:
                buf.writeVarInt(6); 
                console.log(data)
        }
        return buf
    }
}
class ElementFlex extends Element {
    constructor(tag = "div", isElement = false, noUpdateOther = false) {
        super(tag, isElement)
        app.addFlex(this)
        this.class("app-flex")
        this._minwidth  = null
        this._minheight = null
        this._maxwidth  = null
        this._maxheight = null
        this._updateTimer = null
        this._child = 1
        this._childStyle = ''
        this._tag = null
        this._resizes = []
        this._disable = false
        this._customWidths = []
        this.update(!noUpdateOther)
    }
    disable() {
        this._disable = true
        return this
    }
    addResize(func) {
        this._resizes.push(func)
        return this
    }
    append(...elements) {
        super.append(...elements.map(e => this.isDOM(e) || e instanceof Element ? e : (new Element("div")).setHTML(e)))
        return this
    }
    tag(tag) {
        this._tag = tag
        return this
    }
    min_width(width) {
        this.minwidth = width
        return this
    }
    max_width(width) {
        this.maxwidth = width
        return this
    }
    min_height(height) {
        this.minheight = height
        return this
    }
    max_height(height) {
        this.maxheight = height
        return this
    }
    height(height) {
        this.setStyle("height", height)
        return this
    }
    width(width) {
        this.setStyle("width", width)
        return this
    }
    style(key, value) {
        app.setStyle(".app-flex." + key + "_" + value, `${key}: ${value}`)
        this.class(key + "_" + value)
        return this
    }
    update(main = true) {
        if (this._disable) {
            for (const func of this._resizes) {
                func()
            }
            return this
        }
        const get_margin = (child) => {
            const child_style = window.getComputedStyle(child.valueOf());
            const margin = (parseInt(child_style.marginRight, 10) + parseInt(child_style.marginLeft, 10));
            return (Number.isNaN(margin) ? 0 : margin)
        }
        const width = (super.valueOf().offsetWidth - 1)
        const childpercents = this._customWidths.reduce((sum, width) => sum + width, 0);
        let minwidth = this._calcValueWithDisplay(this._minwidth || 0, width)
        let maxwidth = this._calcValueWithDisplay(this._maxwidth, width)
        let newwidth = Number.parseInt(clamp(minwidth, width, maxwidth) / 2) * 2
        const children = this.getChildren()
        const widths = Math.max(0, newwidth)
        let percentWidth = 0
        if (newwidth > minwidth)
            for (let i = 0; i < Math.min(this._customWidths.length, children.length); i++) {
                const child = children[i];
                //child.valueOf().style = this._childStyle
                child.setStyle("boxSizing", "border-box")
                child.setStyle("width", (width * (this._customWidths[i] / childpercents) - get_margin(child)) + "px")
                percentWidth += width * (this._customWidths[i] / childpercents) - get_margin(child)
            }
        const width_avg = Math.max(0, Math.floor((widths - percentWidth) / (this._child - (percentWidth != 0 ? this._customWidths.length : 0))))
        for (let i = Math.min((percentWidth != 0 ? this._customWidths.length : 0), children.length); i < children.length; i++) {
            const child = children[i];
            //child.valueOf().style = this._childStyle
            child.setStyle("boxSizing", "border-box")
            child.setStyle("width", (newwidth <= minwidth ? width : width_avg - get_margin(child)) + "px")
        }
        for (const func of this._resizes) {
            func()
        }
        if (!main) return this
        app.resizeFlex(main)
        return this
    }
    _calcValueWithDisplay(value, display) { 
        if (value == -1 || value == null) return display
        if (typeof value === 'string' && value.includes('%')) {  
            return Math.floor(display * (parseFloat(value.replace('%', '')) / 100));  
        } else {  
            return value;  
        }  
    }  
    childStyle(value) {
        this._childStyle = value
        return this
    }
    minWidth(value) {
        this._minwidth = value
        return this
    }
    minHeight(value) {
        this._minheight = value
        return this
    }
    maxWidth(value) {
        this._maxwidth = value
        return this
    }
    maxHeight(value) {
        this._maxheight = value
        return this
    }
    child(value) {
        this._child = Math.max(1, Number.parseInt(value.toString()))
        return this
    }
    childWidths(...value) {
        this._customWidths = value
        return this;
    }
}
class ElementSwitch extends Element {
    constructor(...buttons) {
        super("div")
        this.buttons = buttons
        this.instancedbuttons = []
        this.selected = 0
        this.class("app-swtich-container")
        this.handlers = []
        for (const bi in this.buttons) {
            this.instancedbuttons.push((new Element("button")).class("app-switch-button").setText(this.buttons[bi]).event("click", (event) => {
                this.click(this.instancedbuttons[bi], bi)
            }))
        }
        this.append(...this.instancedbuttons)
        this.click(this.instancedbuttons[0])
    }
    click(target, index) {
        this.instancedbuttons.forEach(e => e.removeClass("selected"))
        target.class("selected")
        this.handlers.forEach(e => e(index))
    }
    select(index) {
        this.click(this.instancedbuttons[index], index)
        return this
    }
    event(name, func) {
        if (name == "click") {
            this.handlers.push(func)
        } else {
            super.event(name, func)
        }
        return this
    }
}
class ElementRank extends Element {
    constructor(option) {
        this.class("app-rank")
        this.setOption(option)
        this.data = null
    }
    setOption(option) {
        this.config = {
            count: null,
            rows: false,
            formatter: null,
        }
        return this
    }
    setData(data) {
        return this
    }
}
class Console extends Element {
    constructor() {
        super("div")
        this.$styles = {
            ".console": [
                "min-height: 648px",
                "height: 79.5vh",
                "width: 100%",
                "overflow: auto",
                "background-color: black",
                "padding: 8px"
            ]
        }
        app.setStyles(this.$styles)
        this.class("console")
        for (let i = 0; i < 1000; i++) {
            this.log(new Date(), "0")
        }
    }
    log(timestamp, ...msg) {
        var messages = []
        var first = true;
        for (msg of [`[${formatTime(timestamp)}]`, ...msg]) {
            if (first) first = false;
            else messages.push(app.createElement("span").setText(" "))
            var span = app.createElement("span")
            if (msg instanceof Element) {
                span.append(msg)
            } else {
                span.setHTML(msg)
            }
            messages.push(span);
        }
        this.append(
            app.createElement("p").append(
                ...messages
            )
        )
    }
}
class TemplateEchart extends Element {
    constructor() {
        super("div")
        this.instance = echarts.init(this.base)
        this.setOption({
            tooltip: {
                trigger: 'axis',
                formatter: (params) => this._e_templates(params) 
            }
        })
    }
    setOption(option) {
        this.instance.setOption(option)
        return this
    }
    clear() {
        this.instance.clear()
        return this
    }
    resize() {
        this.instance.resize()
        return this
    }
    _e_templates(params, value_formatter = null) {
        const templates = `<div style="margin: 0px 0 0;line-height:1;"><div style="margin: 0px 0 0;line-height:1;"><span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:{color};"></span><span style="font-size:14px;color:#666;font-weight:400;margin-left:2px">{name}</span><span style="float:right;margin-left:20px;font-size:14px;color:#666;font-weight:900">{value}</span><div style="clear:both"></div></div><div style="clear:both"></div></div>`
        var template = ''
        for (const data of params) {
            template += templates.replace("{color}", data.color).replace("{name}", data.seriesName).replace("{value}", value_formatter ? value_formatter(data.value) : data.value)
        }
        return `<div style="margin: 0px 0 0;line-height:1;"><div style="margin: 0px 0 0;line-height:1;"><div style="font-size:14px;color:#666;font-weight:400;line-height:1;">${params[0].name}</div><div style="margin: 10px 0 0;line-height:1;">${template}</div><div style="clear:both"></div></div><div style="clear:both"></div></div>`
    }
    getOption() {
        return this.instance.getOption()
    }
}
const $I18N = new I18NManager()
const formatTime = (timestamp) => {
    timestamp = timestamp instanceof Date ? timestamp : new Date(timestamp);
    return `${timestamp.getFullYear().toString().padStart(4, '0')}-${(timestamp.getMonth() + 1).toString().padStart(2, '0')}-${timestamp.getDate().toString().padStart(2, '0')} ${timestamp.getHours().toString().padStart(2, '0')}:${timestamp.getMinutes().toString().padStart(2, '0')}:${timestamp.getSeconds().toString().padStart(2, '0')}`
}
const formatDate = (timestamp) => {
    timestamp = timestamp instanceof Date ? timestamp : new Date(timestamp);
    return `${timestamp.getFullYear().toString().padStart(4, '0')}-${(timestamp.getMonth() + 1).toString().padStart(2, '0')}-${timestamp.getDate().toString().padStart(2, '0')}`
}
const clamp = (min, cur, max) => {  
    return Math.max(min, Math.min(cur, max));  
} 
const getCookie = (name) => {  
    const value = `; ${document.cookie}`;  
    const parts = value.split(`; ${name}=`);  
    if (parts.length === 2) return parts.pop().split(';').shift();  
    return null;  
}  
const fillDates = (dates) => {  
    const latestDateStr = Object.keys(dates).reduce((latest, current) =>   
        new Date(current + " 00:00:00") > new Date(latest + " 00:00:00") ? current : latest)
    const latestDate = (new Date(latestDateStr + " 00:00:00")).valueOf();  
    const filledDates = {};  
      
    for (let i = Object.keys(filledDates).length; i < 30; i++) {
        filledDates[formatDate(new Date(latestDate + (i - 31) * 86400000))] = 0
    }
    return {...filledDates, ...dates };  
} 
$github = (() => {
    for (child of document.head.children) {
        if (child.getAttribute("github")) return "//github.com/" + child.getAttribute("github")
    }
    return ""
})();
app = new Application()
$preloader = new Preloader()
$progress = new ProgressBar();
const logger = new Console()
const $MainSocket = new SocketData()
const dev = false;
app.$Menu.add("dashboard", new class {
    constructor() {
        this._unit_bytes = ["B", "KB", "MB", "GB", "TB", "PB", "EB"]
        this._unit_number = ["", "k", "M", "G", "T", "P", "E"]
    }
    async init() {
        this.switch = (new ElementSwitch("BASIC", "PRO")).event("click", (index) => {
            this.page[2].clear()
            this.clear()
            if (index == 0) {
                this.initBasic()
                this.page[2].append(...this.basic)
            } else {
                this.initPro()
                this.page[2].append(...this.pro)
            }
            setTimeout(() => {
                this.drawQPS()
            }, 50)
            window.dispatchEvent(new Event("resize"))
        })
        this._be_qps = app.createEcharts().style("min-height: 162px;")
        this._pe_qps = app.createEcharts().style("min-height: 162px;")
        this._e_geo = app.createElement("div").style("min-height: 416px;")
        this._e_visits = app.createEcharts().style("min-height: 162px;")
        this._e_hourly = {
            hits:    app.createEcharts().style("min-height: 162px;"),
            bytes:   app.createEcharts().style("min-height: 162px;")
        }
        this._e_daily = {
            hits:    app.createEcharts().style("min-height: 162px;"),
            bytes:   app.createEcharts().style("min-height: 162px;")
        }
        this.page = [
            app.createElement("div").class("panel").append(
                app.createFlex().append(
                    app.createElement("div").append(
                        app.createElement("p").class("title").setText("dashboard.uptime"),
                        app.createElement("p").class("value").setText("-")
                    ),
                    app.createElement("div").append(
                        app.createElement("p").class("title").setText("dashboard.status"),
                        app.createElement("p").class("value").setText("-")
                    )
                ).minWidth(896).child(2)
            ),
            app.createElement("div").class("panel nopadding").style("margin-bottom: 0").append(
                app.createElement("div").class("flex-space-between").append(
                    this.switch
                )
            ),
            app.createElement("div")
        ]
        this.basic = [
            app.createFlex(true).minWidth(1148).childWidths(60, 40).append(
                app.createElement("div").append(
                    app.createElement("div").class("panel").append(
                        app.createFlex().child(4).append(
                            app.createElement("div").append(
                                app.createElement("p").class("title").setText("dashboard.today.requests"),
                                app.createElement("p").class("value").setText("-")
                            ),
                            app.createElement("div").append(
                                app.createElement("p").class("title").setText("dashboard.today.filebytes"),
                                app.createElement("p").class("value").setText("-")
                            ),
                            app.createElement("div").append(
                                app.createElement("p").class("title").setText("dashboard.in30days.requests"),
                                app.createElement("p").class("value").setText("-")
                            ),
                            app.createElement("div").append(
                                app.createElement("p").class("title").setText("dashboard.in30days.filebytes"),
                                app.createElement("p").class("value").setText("-")
                            )
                        ).minWidth(600)
                    ),
                    app.createElement("div").class("panel").append(
                        app.createFlex().child(4).append(
                            app.createElement("div").append(
                                app.createElement("p").class("title").setText("dashboard.connections"),
                                app.createElement("p").class("value").setText("-")
                            ),
                            app.createElement("div").append(
                                app.createElement("p").class("title").setText("dashboard.memory"),
                                app.createElement("p").class("value").setText("-")
                            ),
                            app.createElement("div").append(
                                app.createElement("p").class("title").setText("dashboard.file_cache"),
                                app.createElement("p").append(
                                    app.createElement("span").class("value").setText("-"),
                                    app.createElement("span")
                                )
                            ),
                            app.createElement("div").append(
                                app.createElement("p").class("title").setText("dashboard.in5mins.load"),
                                app.createElement("p").class("value").setText("-")
                            )
                        ).minWidth(600)
                    )
                ),
                app.createElement("div").class("panel").append(
                    app.createElement("p").class("title").setText("dashboard.in5mins.requests", {count: "-"}),
                    this._be_qps
                )
            ),
            app.createFlex(true).child(2).append(
                app.createElement("div").class("panel").append(
                    app.createElement("p").class("title").setText("dashboard.download.hourly"),
                    this._e_hourly.hits
                ),
                app.createElement("div").class("panel").append(
                    app.createElement("p").class("title").setText("dashboard.bytes.hourly"),
                    this._e_hourly.bytes
                ),
                app.createElement("div").class("panel").append(
                    app.createElement("p").class("title").setText("dashboard.download.daily"),
                    this._e_daily.hits
                ),
                app.createElement("div").class("panel").append(
                    app.createElement("p").class("title").setText("dashboard.bytes.daily"),
                    this._e_daily.bytes
                )
            ).minWidth(1148).addResize(() => {
                for (var e of [this._e_hourly, this._e_daily]) {
                    for (var o of Object.values(e)) {
                        o.resize()
                    }
                }
                this._be_qps.resize()
            })
        ]
        this.pro = [
            app.createFlex(true).minWidth(1148).childWidths(70, 30).append(
                app.createElement("div").class("panel").append(
                    app.createElement("p").class("title").setText("地理位置"),
                    app.createFlex(true).childWidths(70, 30).append(
                        this._e_geo,
                        app.createElement("div").class("rank")
                    )
                ),
                app.createElement("div").append(
                    app.createElement("div").class("panel").append(
                        app.createElement("p").class("title", "flex-space-between").append(
                            app.createElement("span").style("color: var(--title-color)").setText("dashboard.distincts"),
                            app.createElement("span").style("color: var(--title-color)").setText("dashboard.peer", { count: "-" }),
                        ),
                        this._e_visits
                    ),
                    app.createElement("div").class("panel").append(
                        app.createElement("p").class("title").setText("dashboard.in5mins.requests", {count: "-"}),
                        this._pe_qps
                    )
                )
            ).addResize(() => {
                this._pe_qps.resize(),
                this._e_visits.resize()
            }), ""
        ];
        this.initGlobals()
        this.initPro()
        window.addEventListener("themeChange", () => {
            this.drawDashboard()
            this.drawQPS()
        })
        await $MainSocket.send("uptime").then((data) => {
            this.uptime = data
        })
        await $MainSocket.send("status").then((data) => {
            this.status = data
        })
        await $MainSocket.send("qps").then((data) => {
            this.qps = data
            this.drawQPS()
        })
        await $MainSocket.send("dashboard").then((data) => {
            this.dashboard = data
            this.drawDashboard()
        })
        window.addEventListener("mainsocket_status", (data) => {
            this.status = data.detail
            this.setStatus()
        })
        window.addEventListener("mainsocket_disconnect", (data) => {
            this.uptime = null
        })
        window.addEventListener("mainsocket_connect", (data) => {
            $MainSocket.send("uptime").then((data) => {
                this.uptime = data
            })
        })
        this.initBasic()
        this.switch.select(1)
    }
    initGlobals() {
        var option = {
            tooltip: {
                trigger: 'axis',
            },
            stateAnimation: {
                duration: 300,
                easing: "cubicOut"
            },
            xAxis: {
                type: "category",
                show: false,
            },
            yAxis: {
                show: false,
                type: "value",
            },
            grid: {
                top: 10,
                bottom: 10,
                right: 0,
                left: 0,
                show: !1,
                z: 0,
                containLabel: !1,
                backgroundColor: "rgba(0,0,0,0)",
                borderWidth: 1,
                borderColor: "#ccc"
            },
            series: [
                {
                    type: "bar",
                    barGap: "0",
                    barMinHeight: 4,
                    itemStyle: {
                        borderRadius: [2, 2, 0, 0]
                    },
                    z: 2,
                    backgroundStyle: {
                        color: "rgba(180, 180, 180, 0.2)",
                        borderColor: null,
                        borderWidth: 0,
                        borderType: "solid",
                        borderRadius: 0,
                        shadowBlur: 0,
                        shadowColor: null,
                        shadowOffsetX: 0,
                        shadowOffsetY: 0
                    },
                    select: {
                        itemStyle: {
                            borderColor: "#212121"
                        }
                    },
                }
            ]
        }
        this._be_qps.setOption(option)
        this._pe_qps.setOption(option)
        this.uptimeTimer = app.runTaskRepeat(() => {
            this.page[0].getChildren()[0].getChildren()[0].getChildren()[1].setText(this._format_time(this.uptime, true))
        }, 0, 1000)
    }
    initBasic() {
        this.initGlobals()
        this._e_options = {  
            tooltip: {  
                trigger: 'axis'  
            },  
            grid: {  
                left: '3%',  
                right: '4%',  
                bottom: '3%',
                top: '20%',
                containLabel: true  
            },  
            xAxis: {  
                type: 'category',
            },  
            yAxis: {  
                type: 'value',
                min: 1,
                max: 10
            },  
            series: []  
        };  
        
        for (var e of [this._e_hourly, this._e_daily]) {
            for (var o of Object.values(e)) {
                o.setOption(this._e_options)
            }
        }
        this.setStatus();
        this.qpsTimer?.block()
        this.systemTimer?.block()
        this.qpsTimer = app.runTaskRepeat(() => {
            $MainSocket.send("qps").then((data) => {
                this.qps = data
                this.drawQPS()
            })
        }, 0, 5000)
        this.systemTimer = app.runTaskRepeat(() => {
            $MainSocket.send("system").then((data) => {
                this.system = data
                this.drawSystem()
            })
        }, 0, 1000)
        this.dashboardTimer = app.runTaskRepeat(() => {
            $MainSocket.send("dashboard").then((data) => {
                this.dashboard = data
                this.drawDashboard()
                this.drawSystem()
            })
        }, 0, 10000)
    }
    initPro() {
        this.initGlobals()
        this._e_visits.setOption({
            color: app.getThemeVar("main-color"),
            yAxis: [
                {
                    type: "value",
                    show: false
                }
            ],
            tooltip: {
                trigger: "axis",
            },
            xAxis: [
                {
                    type: "category",
                    show: false,
                }
            ],
            stateAnimation: {
                duration: 300,
                easing: "cubicOut"
            },
            grid: [
                {
                    top: 5,
                    bottom: 20,
                    right: 0,
                    left: 0,
                    show: false,
                    z: 0,
                    containLabel: false,
                    backgroundColor: "rgba(0,0,0,0)",
                    borderWidth: 1,
                    borderColor: "#ccc"
                }
            ],
            series: [
                {
                    name: "dashboard.visits",
                    type: "line",
                    symbol: "none",
                    data: [],
                    smooth: true,
                    lineStyle: {
                        width: 3,
                        color: {
                            type: "linear",
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            global: false,
                            colorStops: [{offset: 0, color: app.getThemeVar("echarts-main-color")},{offset: 1, color: app.getThemeVar("echarts-dark-color")}]
                        },
                        type:" solid"
                    },
                    itemStyle: {borderRadius: [2, 2, 0, 0]},
                    z: 3,
                }
            ]
        })
        this.globalTimer = app.runTaskRepeat(() => {
            $MainSocket.send("global_stats").then((data) => {
                this.global_stats = data,
                this.drawGlobals()
            })
        }, 0, 360000)
    }
    clearPro() {
        this.globalTimer?.block()
        this._e_visits.clear()
    }
    clearBasic() {
        this.systemTimer?.block()
        this.dashboardTimer?.block()
        this.basic[0].getChildren()[0].getChildren()[0].getChildren()[0].getChildren()[0].getChildren()[1].setText("-")
        this.basic[0].getChildren()[0].getChildren()[0].getChildren()[0].getChildren()[1].getChildren()[1].setText("-")
        this.basic[0].getChildren()[0].getChildren()[0].getChildren()[0].getChildren()[2].getChildren()[1].setText("-")
        this.basic[0].getChildren()[0].getChildren()[0].getChildren()[0].getChildren()[3].getChildren()[1].setText("-")
        this.basic[0].getChildren()[0].getChildren()[1].getChildren()[0].getChildren()[0].getChildren()[1].setText("-")
        this.basic[0].getChildren()[0].getChildren()[1].getChildren()[0].getChildren()[1].getChildren()[1].setText("-")
        this.basic[0].getChildren()[0].getChildren()[1].getChildren()[0].getChildren()[2].getChildren()[1].getChildren()[0].setText("-")
        this.basic[0].getChildren()[0].getChildren()[1].getChildren()[0].getChildren()[2].getChildren()[1].getChildren()[1].setText("-")
        this.basic[0].getChildren()[0].getChildren()[1].getChildren()[0].getChildren()[3].getChildren()[1].setText("-")
        for (var e of [this._e_hourly, this._e_daily]) {
            for (var o of Object.values(e)) {
                o.clear()
            }
        }
    }
    clear() {
        this.uptimeTimer?.block()
        this.clearPro()
        this.clearBasic()
        this._be_qps.clear()
        this._pe_qps.clear()
    }
    _e_templates(params, value_formatter = null) {
        const templates = `<div style="margin: 0px 0 0;line-height:1;"><div style="margin: 0px 0 0;line-height:1;"><span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:{color};"></span><span style="font-size:14px;color:#666;font-weight:400;margin-left:2px">{name}</span><span style="float:right;margin-left:20px;font-size:14px;color:#666;font-weight:900">{value}</span><div style="clear:both"></div></div><div style="clear:both"></div></div>`
        var template = ''
        for (const data of params) {
            template += templates.replace("{color}", data.color).replace("{name}", data.name).replace("{value}", value_formatter ? value_formatter(data.value) : data.value)
        }
        return `<div style="margin: 0px 0 0;line-height:1;"><div style="margin: 0px 0 0;line-height:1;"><div style="font-size:14px;color:#666;font-weight:400;line-height:1;">${params[0].name}</div><div style="margin: 10px 0 0;line-height:1;">${template}</div><div style="clear:both"></div></div><div style="clear:both"></div></div>`
    }
    _hourly() {
        return Array.from({length: 24}, (_, i) => i + " unit.hourly")
    }
    _daily() {
        return Array.from({length: 31}, (_, i) => i + " unit.daily")
    }
    _format_bytes(size, i = null) {
        if (size == 0) return `${size.toFixed(2)}${this._unit_bytes[0]}`
        i = i || Math.min(Number.parseInt(Math.floor(Math.log(size) / Math.log(1024))), this._unit_bytes.length)
        if (i <= 0) return `${size.toFixed(2)}${this._unit_bytes[0]}` 
        size = size / (1024 ** i)
        return `${size.toFixed(2)}${this._unit_bytes[i]}`
    }
    _format_number_unit(n) {
        var d = (n + "").split("."), i = d[0], f = d.length >= 2 ? "." + d.slice(1).join(".") : ""
        return i.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ", ") + f;
    }
    drawDashboard() {
        const data = this.dashboard
        const hourly_data = data.hourly
        const daily_data = data.days;
        {
            let min = Math.max(...hourly_data.map(v => v._hour))
            let io, cache;
            {
                io = Array.from({ length: min }, (_, __) => 0);
                cache = Array.from({ length: min }, (_, __) => 0);
                for (const val of hourly_data) {
                    io[val._hour] = val.hits
                    cache[val._hour] = val.cache_hits
                    min = Math.max(min, val._hour)
                }
                this._e_hourly.hits.setOption({
                    xAxis: {
                        data: this._hourly()
                    },
                    legend: {
                        data: ["dashboard.io.hits", "dashboard.cache.hits"],
                        textStyle: {
                            color: app.getThemeVar("color")
                        }
                    },
                    yAxis: {
                        max: Math.max(10, ...io, ...cache),
                    },
                    series: [{
                        name: "dashboard.io.hits",
                        data: io,
                        type: 'line',  
                        smooth: true,
                    }, {
                        name: "dashboard.cache.hits",
                        data: cache,
                        type: 'line',  
                        smooth: true
                    }]
                })


                io = Array.from({ length: min }, (_, __) => 0);
                cache = Array.from({ length: min }, (_, __) => 0);
                for (const val of hourly_data) {
                    io[val._hour] = val.bytes
                    cache[val._hour] = val.cache_bytes
                }
                this._e_hourly.bytes.setOption({
                    xAxis: {
                        data: this._hourly()
                    },
                    tooltip: {
                        formatter: (params) => {
                            return this._e_templates(params, v => this._format_bytes(v))
                        }
                    },
                    legend: {
                        data: ["dashboard.io.bytes", "dashboard.cache.bytes"],
                        textStyle: {
                            color: app.getThemeVar("color")
                        }
                    },
                    yAxis: {
                        max: Math.max(10, ...io, ...cache),
                        axisLabel: {
                            formatter: (value) => {
                                return this._format_bytes(value)
                            }
                        }
                    },
                    series: [{
                        name: "dashboard.io.bytes",
                        data: io,
                        type: 'line',  
                        smooth: true,
                    }, {
                        name: "dashboard.cache.bytes",
                        data: cache,
                        type: 'line',  
                        smooth: true
                    }]
                })
            }
        }
        {
            let io, cache;
            {
                io = {}
                cache = {}
                for (const val of daily_data) {
                    io[val._day] = val.hits
                    cache[val._day] = val.cache_hits
                }
                io = fillDates(io)
                cache = fillDates(cache)
                this._e_daily.hits.setOption({
                    xAxis: {
                        data: Object.keys(io)
                    },
                    legend: {
                        data: ["dashboard.io.hits", "dashboard.cache.hits"],
                        textStyle: {
                            color: app.getThemeVar("color")
                        }
                    },
                    yAxis: {
                        max: Math.max(10, ...Object.values(io), ...Object.values(cache)),
                    },
                    series: [{
                        name: "dashboard.io.hits",
                        data: Object.values(io),
                        type: 'line',  
                        smooth: true,
                    }, {
                        name: "dashboard.cache.hits",
                        data: Object.values(cache),
                        type: 'line',  
                        smooth: true
                    }]
                })


                io = {}
                cache = {}
                for (const val of daily_data) {
                    io[val._day] = val.bytes
                    cache[val._day] = val.cache_bytes
                }
                io = fillDates(io)
                cache = fillDates(cache)
                this._e_daily.bytes.setOption({
                    xAxis: {
                        data: Object.keys(io)
                    },
                    tooltip: {
                        formatter: (params) => {
                            return this._e_templates(params, v => this._format_bytes(v))
                        }
                    },
                    legend: {
                        data: ["dashboard.io.bytes", "dashboard.cache.bytes"],
                        textStyle: {
                            color: app.getThemeVar("color")
                        }
                    },
                    yAxis: {
                        max: Math.max(10, ...Object.values(io), ...Object.values(cache)),
                        axisLabel: {
                            formatter: (value) => {
                                return this._format_bytes(value)
                            }
                        }
                    },
                    series: [{
                        name: "dashboard.io.bytes",
                        data: Object.values(io),
                        type: 'line',  
                        smooth: true,
                    }, {
                        name: "dashboard.cache.bytes",
                        data: Object.values(cache),
                        type: 'line',  
                        smooth: true
                    }]
                })
            }
        }
        //console.log(bytes, io)
    }
    drawQPS() {
        try {
            var option = {
                color: app.getThemeVar("main-color"),
                xAxis: {
                    data: Object.keys(this.qps)
                },
                series: [{name: 'QPS', data: Object.values(this.qps)}]
            }
            this._be_qps.setOption(option)
            this._pe_qps.setOption(option)
        } catch (e) {
            
        }
    }
    drawSystem() {
        var hits, bytes;
        hits  = this.dashboard.hourly.reduce((sum, i) => sum + i.hits + i.cache_hits, 0)
        bytes = this.dashboard.hourly.reduce((sum, i) => sum + i.bytes + i.cache_bytes, 0)
        this.basic[0].getChildren()[0].getChildren()[0].getChildren()[0].getChildren()[0].getChildren()[1].setText(this._format_number_unit(hits))
        this.basic[0].getChildren()[0].getChildren()[0].getChildren()[0].getChildren()[1].getChildren()[1].setText(this._format_bytes(bytes))
        hits  = this.dashboard.days.reduce((sum, i) => sum + i.hits + i.cache_hits, 0)
        bytes = this.dashboard.days.reduce((sum, i) => sum + i.bytes + i.cache_bytes, 0)
        this.basic[0].getChildren()[0].getChildren()[0].getChildren()[0].getChildren()[2].getChildren()[1].setText(this._format_number_unit(hits))
        this.basic[0].getChildren()[0].getChildren()[0].getChildren()[0].getChildren()[3].getChildren()[1].setText(this._format_bytes(bytes))

        this.basic[0].getChildren()[0].getChildren()[1].getChildren()[0].getChildren()[0].getChildren()[1].setText(this._format_number_unit(this.system.connections))
        this.basic[0].getChildren()[0].getChildren()[1].getChildren()[0].getChildren()[1].getChildren()[1].setText(this._format_bytes(this.system.memory))
        this.basic[0].getChildren()[0].getChildren()[1].getChildren()[0].getChildren()[2].getChildren()[1].getChildren()[0].setText(this._format_number_unit(this.system.cache.total))
        this.basic[0].getChildren()[0].getChildren()[1].getChildren()[0].getChildren()[2].getChildren()[1].getChildren()[1].setText(`(${this._format_bytes(this.system.cache.bytes)})`)
        this.basic[0].getChildren()[0].getChildren()[1].getChildren()[0].getChildren()[3].getChildren()[1].setText(this.system.cpu.toFixed(2) + "%")
    }
    drawGlobals() {
        var visits = fillDates(this.global_stats.daily.distinct_ip) 
        this._e_visits.setOption({
            xAxis: {
                data: Object.keys(visits)
            },
            series: [
                {
                    data: Object.values(visits),
                    type: 'line',  
                    smooth: true,
                }
            ]
        })
    }
    setStatus() {
        this.page[0].getChildren()[0].getChildren()[1].getChildren()[1].setText(this.status.progress ? this.status.progress.desc : this.status.key)
    }
    _format_time(n, sub = false) {
        if (n == null) return "-"
        let seconds = Number.parseInt(n)
        if (sub) seconds = Number.parseInt((new Date()).valueOf() / 1000.0 - seconds)
        return `${parseInt(seconds / 60 / 60 / 24).toString().padStart(2, '0')} 天 ${parseInt(seconds / 60 / 60 % 24).toString().padStart(2, '0')} 小时 ${parseInt(seconds / 60 % 60).toString().padStart(2, '0')} 分钟 ${parseInt(seconds % 60).toString().padStart(2, '0')} 秒`
    }
    connect() {
        return new Promise(async (resolve, reject) => {
            await this.init()
            resolve(this.page)
            setTimeout(() => window.dispatchEvent(new Event("resize")), 1)
        })
    }
    resize() {
    }
    disconnect() {
        this.qpsTimer?.block()
        this.systemTimer?.block()
        this.dashboardTimer?.block()
        this.uptimeTimer?.block()
        this.globalTimer?.block()
        for (var e of [this._e_hourly, this._e_daily]) {
            for (var o of Object.values(e)) {
                o.clear()
            }
        }
        this._e_qps.clear()
    }
})
app.$Menu.add("config.storage", new class {
    constructor() {

    }
    connect() {
        return new Promise((resolve, reject) => {

        })
    }
    disconnect() {

    }
})
if (dev) {
    app.$Menu.add("dev.web", new class {
        connect() {
            this.page = [
                app.createElement("div").class("panel").append(
                    app.createElement("p").class("title").setText(
                        "dev.web.console"
                    ),
                    logger
                )
            ]
            return new Promise(async (resolve, reject) => {
                resolve(this.page)
            })
        }
        disconnect() {
    
        }
    })
}
window.addEventListener("load", () => {
    app.$Router.handler()
})
app.$Menu.render();
window.addEventListener("resize", () => {
    app.$Menu.resize()
    console.log("resize")
})